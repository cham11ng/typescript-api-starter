import fs from 'fs';
import { TransformableInfo } from 'logform';
import { createLogger, format, Logger, transports } from 'winston';
import DailyRotateFile from 'winston-daily-rotate-file';

import app from '../config/config';
import context from './context';

const { environment, logging } = app;
const { combine, colorize, splat, printf, timestamp } = format;

const keysToFilter = ['password', 'token'];

const formatter = printf((info: TransformableInfo) => {
  const { level, message, timestamp: ts, ...restMeta } = info;
  const transactionId = context?.getStore()?.get('transactionId') || '-';

  const meta =
    restMeta && Object.keys(restMeta).length
      ? JSON.stringify(restMeta, (key: string, value) => (keysToFilter.includes(key) ? '******' : value), 2)
      : restMeta instanceof Object
        ? ''
        : restMeta;

  return `[ ${ts} ] [ ${transactionId} ] - [ ${level} ] ${message} ${meta}`;
});

// eslint-disable-next-line @typescript-eslint/no-explicit-any
let trans: any = [];
let logger: Logger;

/*
 Send logs to console if log file generation is not supported.
 Heroku is an example cloud service provider that uses plug-ins to monitor logs
 and logs are sent to console. Accessing the log files generated by the app poses a difficult task.
 */
if (logging.logFileGenarationSupport === 'false') {
  logger = createLogger({
    level: logging.level,
    format: combine(splat(), colorize(), timestamp(), formatter),
    transports: [new transports.Console()]
  });
} else {
  if (!fs.existsSync('logs')) {
    fs.mkdirSync('logs');
  }

  if (environment === 'development') {
    trans = [new transports.Console()];
  }

  logger = createLogger({
    level: logging.level,
    format: combine(splat(), colorize(), timestamp(), formatter),
    transports: [
      ...trans,
      new DailyRotateFile({
        maxSize: logging.maxSize,
        maxFiles: logging.maxFiles,
        datePattern: logging.datePattern,
        zippedArchive: true,
        filename: `logs/${logging.level}-%DATE%.log`
      })
    ]
  });
}

export default logger;
